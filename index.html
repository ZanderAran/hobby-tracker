<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hobby Time Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .container { max-width: 1100px; }
    .chip { display:inline-block; font-size:0.75rem; line-height:1rem; padding:0.25rem 0.5rem; border-radius:0.5rem; background:#e5e7eb; margin-right:0.25rem; margin-bottom:0.25rem; }
  </style>
</head>

<body class="bg-slate-100 text-slate-900">
  <header class="bg-white shadow">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">Hobby Time Tracker</h1>
      <div class="flex items-center gap-2">
        <button id="exportBtn" class="px-3 py-1.5 rounded bg-slate-800 text-white hover:bg-slate-700">Export JSON</button>
        <label for="importFile" class="px-3 py-1.5 rounded bg-slate-200 hover:bg-slate-300 cursor-pointer">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" />
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">

    <!-- SUMMARY -->
    <section class="bg-white p-4 rounded-2xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-3">Summary</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-3 rounded-xl bg-slate-50 border">
          <div class="text-sm text-slate-500">Total Minutes</div>
          <div id="totalMinutes" class="text-2xl font-semibold">0</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-50 border">
          <div class="text-sm text-slate-500">Total Hours</div>
          <div id="totalHours" class="text-2xl font-semibold">0.0</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-50 border">
          <div class="text-sm text-slate-500">Entries</div>
          <div id="totalEntries" class="text-2xl font-semibold">0</div>
        </div>
      </div>
      <div class="mt-4">
        <h3 class="font-semibold mb-2">By Category</h3>
        <div id="byCategory" class="flex flex-wrap gap-2"></div>
      </div>
    </section>

    <!-- ðŸ“Š TIME USAGE GRAPH -->
    <section class="bg-white p-4 rounded-2xl shadow mb-6">
      <h2 class="text-lg font-semibold mb-3">Time Usage Graph</h2>
      <div class="flex flex-wrap gap-4 items-end mb-4">
        <div>
          <label class="block text-sm mb-1">Group By</label>
          <select id="graphGroupBy" class="border rounded px-2 py-1">
            <option value="category" selected>Category</option>
            <option value="subactivity">Subactivity</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">Filter by Tags</label>
          <input id="graphTagFilter" type="text" placeholder="e.g. painting, gaming" class="border rounded px-2 py-1 w-64" />
        </div>
        <button id="updateGraphBtn" class="px-4 py-2 rounded bg-slate-800 text-white hover:bg-slate-700">Update Graph</button>
      </div>
      <canvas id="timeChart" class="w-full h-80"></canvas>
    </section>

    <!-- ENTRIES TABLE -->
    <section class="bg-white p-4 rounded-2xl shadow">
      <h2 class="text-lg font-semibold mb-3">Entries</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="text-left px-3 py-2">Date</th>
              <th class="text-left px-3 py-2">Category</th>
              <th class="text-left px-3 py-2">Subactivity</th>
              <th class="text-left px-3 py-2">Minutes</th>
              <th class="text-left px-3 py-2">Tags</th>
              <th class="text-left px-3 py-2">Notes</th>
            </tr>
          </thead>
          <tbody id="entriesTbody"></tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
    const LS_KEYS = { entries: 'hobby.entries.v1' };
    const CLOUD_SYNC_URL = 'https://script.google.com/macros/s/AKfycbxSIFgAAr6umQ3SZmXZomU3c6-Vh4eLnRV1mIw-LTim_0jJaf41ipn0U4-1lHU4bWpyiw/exec';
    const CLOUD_SECRET = 'protect-hobbies';
    let entries = [];

    const totalMinutesEl = document.getElementById('totalMinutes');
    const totalHoursEl = document.getElementById('totalHours');
    const totalEntriesEl = document.getElementById('totalEntries');
    const byCategoryEl = document.getElementById('byCategory');
    const entriesTbody = document.getElementById('entriesTbody');

    function saveAll(){ localStorage.setItem(LS_KEYS.entries, JSON.stringify(entries)); }
    function loadAll(){ entries = JSON.parse(localStorage.getItem(LS_KEYS.entries) || '[]'); }

    async function pullFromCloud(){
      const res = await fetch(CLOUD_SYNC_URL);
      const data = await res.json();
      if (Array.isArray(data.entries)) { entries = data.entries; saveAll(); }
    }

    async function pushToCloud(){
      await fetch(CLOUD_SYNC_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ secret: CLOUD_SECRET, entries })
      });
    }

    function renderSummary(){
      const totalMin = entries.reduce((s,e)=>s+Number(e.minutes||0),0);
      totalMinutesEl.textContent = totalMin;
      totalHoursEl.textContent = (totalMin/60).toFixed(1);
      totalEntriesEl.textContent = entries.length;
      const byCat = {};
      entries.forEach(e=>{ byCat[e.category]=(byCat[e.category]||0)+Number(e.minutes||0); });
      byCategoryEl.innerHTML='';
      for(const [cat,min] of Object.entries(byCat)){
        const div=document.createElement('div');
        div.className='chip';
        div.textContent=`${cat}: ${(min/60).toFixed(1)}h`;
        byCategoryEl.appendChild(div);
      }
    }

    function renderTable(){
      entriesTbody.innerHTML='';
      entries.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="px-3 py-2">${new Date(e.date).toLocaleDateString()}</td>
          <td class="px-3 py-2">${e.category}</td>
          <td class="px-3 py-2">${e.subactivity}</td>
          <td class="px-3 py-2">${e.minutes}</td>
          <td class="px-3 py-2">${(e.tags||[]).map(t=>`<span class='chip'>${t}</span>`).join('')}</td>
          <td class="px-3 py-2">${e.notes||''}</td>`;
        entriesTbody.appendChild(tr);
      });
    }

    // ðŸŽ¨ Chart setup
    let chart = null;
    const ctx = document.getElementById('timeChart').getContext('2d');
    const graphGroupBy = document.getElementById('graphGroupBy');
    const graphTagFilter = document.getElementById('graphTagFilter');
    const updateGraphBtn = document.getElementById('updateGraphBtn');

    function renderGraph(){
      const groupBy = graphGroupBy.value;
      const tags = graphTagFilter.value.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
      const filtered = tags.length ? entries.filter(e=>e.tags.some(t=>tags.includes(t.toLowerCase()))) : entries;

      const grouped = {};
      filtered.forEach(e=>{
        const day = new Date(e.date).toISOString().split('T')[0];
        const key = groupBy==='category'? e.category : e.subactivity;
        grouped[day] ||= {};
        grouped[day][key] = (grouped[day][key]||0) + Number(e.minutes||0);
      });

      const days = Object.keys(grouped).sort();
      const labels = [...new Set(filtered.map(e=>groupBy==='category'?e.category:e.subactivity))];
      const colors = labels.map((_,i)=>`hsl(${i*45%360},70%,65%)`);
      const datasets = labels.map((label,i)=>({
        label,
        data: days.map(d=>(grouped[d]?.[label]||0)/60),
        backgroundColor: colors[i],
        stack: 'stack1'
      }));

      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'bar',
        data:{ labels: days, datasets },
        options:{
          responsive:true,
          plugins:{ tooltip:{ callbacks:{
            label:(c)=>`${c.dataset.label}: ${c.formattedValue}h`
          }}, legend:{ position:'bottom' } },
          scales:{ x:{ stacked:true }, y:{ stacked:true, title:{ display:true, text:'Hours' } } }
        }
      });
    }

    updateGraphBtn.addEventListener('click', renderGraph);

    (async()=>{
      loadAll();
      await pullFromCloud().catch(()=>{});
      saveAll();
      renderSummary();
      renderTable();
      renderGraph();
    })();
  </script>
</body>
</html>
